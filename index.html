<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>蟹江町お散歩バス</title>
    <style>
        :root {
            --primary-color: #3498db;
            --secondary-color: #2980b9;
            --background-color: #f9f9f9;
            --text-color: #333;
            --accent-color: #e74c3c;
            --success-color: #2ecc71;
        }

        body {
            font-family: 'Helvetica Neue', Arial, sans-serif;
            background-color: var(--background-color);
            color: var(--text-color);
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }

        .container {
            width: 90%;
            max-width: 600px;
            margin: 20px auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            padding: 20px;
        }

        header {
            text-align: center;
            padding: 10px 0;
            border-bottom: 1px solid #eee;
            margin-bottom: 20px;
        }

        h1 {
            font-size: 1.8rem;
            color: var(--primary-color);
            margin: 0;
        }

        .info-panel {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .info-card {
            padding: 15px;
            border-radius: 8px;
            background: #f5f5f5;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .card-title {
            font-weight: bold;
            margin-bottom: 5px;
            font-size: 0.9rem;
            color: #666;
        }

        .card-content {
            font-size: 1.2rem;
            font-weight: bold;
        }

        .time-display .card-content {
            font-size: 1.5rem;
        }

        .bus-status {
            font-size: 1.4rem;
            text-align: center;
            padding: 15px;
            margin: 20px 0;
            border-radius: 8px;
        }

        .operating {
            background-color: #dff0d8;
            color: #3c763d;
        }

        .not-operating {
            background-color: #f2dede;
            color: #a94442;
        }

        .next-bus {
            text-align: center;
            font-size: 1.3rem;
            padding: 10px;
            background-color: var(--primary-color);
            color: white;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .button-container {
            display: flex;
            justify-content: center;
            margin-top: 20px;
        }

        button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1rem;
            transition: background-color 0.3s;
        }

        button:hover {
            background-color: var(--secondary-color);
        }

        .bus-stop-selector {
            margin: 15px 0;
        }

        .bus-stop-selector select {
            width: 100%;
            padding: 10px;
            border-radius: 5px;
            border: 1px solid #ddd;
            font-size: 1rem;
        }

        footer {
            margin-top: 20px;
            text-align: center;
            font-size: 0.8rem;
            color: #666;
            padding: 10px;
        }

        .loading {
            text-align: center;
            padding: 20px;
            font-style: italic;
            color: #666;
        }

        @media (prefers-color-scheme: dark) {
            :root {
                --background-color: #222;
                --text-color: #f5f5f5;
            }
            
            body {
                background-color: var(--background-color);
                color: var(--text-color);
            }
            
            .container {
                background: #333;
            }
            
            .info-card {
                background: #444;
                color: #f5f5f5;
            }
            
            .card-title {
                color: #ccc;
            }
            
            .operating {
                background-color: #1e3e1e;
                color: #8cd98c;
            }
            
            .not-operating {
                background-color: #3e1e1e;
                color: #d98c8c;
            }

            select {
                background-color: #444;
                color: #f5f5f5;
                border: 1px solid #555;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>蟹江町お散歩バス</h1>
        </header>

        <div class="info-panel">
            <div class="info-card time-display">
                <div class="card-title">現在時刻</div>
                <div class="card-content" id="current-time">読み込み中...</div>
            </div>

            <div class="bus-stop-selector">
                <select id="bus-stop-select">
                    <option value="loading">バス停を読み込み中...</option>
                </select>
            </div>

            <div class="bus-status" id="bus-status">
                情報を取得中...
            </div>

            <div class="next-bus" id="next-bus">
                次のバス情報を計算中...
            </div>
        </div>

        <div class="button-container">
            <button id="refresh-btn">情報を更新する</button>
        </div>
    </div>

    <footer>
        © 蟹江町お散歩バスアプリ
    </footer>

    <script>
        // 日本語の曜日配列
        const weekdays = ['日', '月', '火', '水', '木', '金', '土'];
        
        // 祝日のリスト (2025年まで)
        const holidays = [
            "2024-01-01", "2024-01-08", "2024-02-11", "2024-02-12", "2024-02-23", 
            "2024-03-20", "2024-04-29", "2024-05-03", "2024-05-04", "2024-05-05", 
            "2024-05-06", "2024-07-15", "2024-08-11", "2024-08-12", "2024-09-16", 
            "2024-09-22", "2024-09-23", "2024-10-14", "2024-11-03", "2024-11-04", 
            "2024-11-23", "2025-01-01", "2025-01-13", "2025-02-11", "2025-02-23", 
            "2025-02-24", "2025-03-20", "2025-04-29", "2025-05-03", "2025-05-04", 
            "2025-05-05", "2025-05-06", "2025-07-21", "2025-08-11", "2025-09-15", 
            "2025-09-23", "2025-10-13", "2025-11-03", "2025-11-23", "2025-11-24"
        ];
        
        // バス停名リスト (Googleスプレッドシートから取得したデータ)
        const busStops = [
            "蟹江町役場",
            "蟹江本町",
            "近鉄蟹江駅",
            "蟹江駅南",
            "福祉センター",
            "大海用",
            "蟹江西保育所",
            "西之森",
            "山吉",
            "西大海用",
            "須西小学校",
            "宝三宝蔵",
            "舟入四丁目",
            "舟入二丁目",
            "ヨシヅヤ前",
            "今西",
            "JR蟹江駅北口"
        ];
        
        // 時刻表データ (実際のスプレッドシートから取得)
        const busSchedule = {
            // 平日の時刻表
            weekday: {
                "蟹江町役場": ["8:30", "9:30", "10:30", "11:30", "13:30", "14:30", "15:30", "16:30"],
                "蟹江本町": ["8:31", "9:31", "10:31", "11:31", "13:31", "14:31", "15:31", "16:31"],
                "近鉄蟹江駅": ["8:33", "9:33", "10:33", "11:33", "13:33", "14:33", "15:33", "16:33"],
                "蟹江駅南": ["8:34", "9:34", "10:34", "11:34", "13:34", "14:34", "15:34", "16:34"],
                "福祉センター": ["8:36", "9:36", "10:36", "11:36", "13:36", "14:36", "15:36", "16:36"],
                "大海用": ["8:37", "9:37", "10:37", "11:37", "13:37", "14:37", "15:37", "16:37"],
                "蟹江西保育所": ["8:39", "9:39", "10:39", "11:39", "13:39", "14:39", "15:39", "16:39"],
                "西之森": ["8:41", "9:41", "10:41", "11:41", "13:41", "14:41", "15:41", "16:41"],
                "山吉": ["8:42", "9:42", "10:42", "11:42", "13:42", "14:42", "15:42", "16:42"],
                "西大海用": ["8:44", "9:44", "10:44", "11:44", "13:44", "14:44", "15:44", "16:44"],
                "須西小学校": ["8:46", "9:46", "10:46", "11:46", "13:46", "14:46", "15:46", "16:46"],
                "宝三宝蔵": ["8:48", "9:48", "10:48", "11:48", "13:48", "14:48", "15:48", "16:48"],
                "舟入四丁目": ["8:50", "9:50", "10:50", "11:50", "13:50", "14:50", "15:50", "16:50"],
                "舟入二丁目": ["8:52", "9:52", "10:52", "11:52", "13:52", "14:52", "15:52", "16:52"],
                "ヨシヅヤ前": ["8:53", "9:53", "10:53", "11:53", "13:53", "14:53", "15:53", "16:53"],
                "今西": ["8:55", "9:55", "10:55", "11:55", "13:55", "14:55", "15:55", "16:55"],
                "JR蟹江駅北口": ["8:58", "9:58", "10:58", "11:58", "13:58", "14:58", "15:58", "16:58"]
            },
            // 土曜日の時刻表
            saturday: {
                "蟹江町役場": ["9:30", "10:30", "11:30", "13:30", "14:30", "15:30"],
                "蟹江本町": ["9:31", "10:31", "11:31", "13:31", "14:31", "15:31"],
                "近鉄蟹江駅": ["9:33", "10:33", "11:33", "13:33", "14:33", "15:33"],
                "蟹江駅南": ["9:34", "10:34", "11:34", "13:34", "14:34", "15:34"],
                "福祉センター": ["9:36", "10:36", "11:36", "13:36", "14:36", "15:36"],
                "大海用": ["9:37", "10:37", "11:37", "13:37", "14:37", "15:37"],
                "蟹江西保育所": ["9:39", "10:39", "11:39", "13:39", "14:39", "15:39"],
                "西之森": ["9:41", "10:41", "11:41", "13:41", "14:41", "15:41"],
                "山吉": ["9:42", "10:42", "11:42", "13:42", "14:42", "15:42"],
                "西大海用": ["9:44", "10:44", "11:44", "13:44", "14:44", "15:44"],
                "須西小学校": ["9:46", "10:46", "11:46", "13:46", "14:46", "15:46"],
                "宝三宝蔵": ["9:48", "10:48", "11:48", "13:48", "14:48", "15:48"],
                "舟入四丁目": ["9:50", "10:50", "11:50", "13:50", "14:50", "15:50"],
                "舟入二丁目": ["9:52", "10:52", "11:52", "13:52", "14:52", "15:52"],
                "ヨシヅヤ前": ["9:53", "10:53", "11:53", "13:53", "14:53", "15:53"],
                "今西": ["9:55", "10:55", "11:55", "13:55", "14:55", "15:55"],
                "JR蟹江駅北口": ["9:58", "10:58", "11:58", "13:58", "14:58", "15:58"]
            },
            // 日曜・祝日の時刻表
            holiday: {
                "蟹江町役場": ["10:30", "11:30", "13:30", "14:30"],
                "蟹江本町": ["10:31", "11:31", "13:31", "14:31"],
                "近鉄蟹江駅": ["10:33", "11:33", "13:33", "14:33"],
                "蟹江駅南": ["10:34", "11:34", "13:34", "14:34"],
                "福祉センター": ["10:36", "11:36", "13:36", "14:36"],
                "大海用": ["10:37", "11:37", "13:37", "14:37"],
                "蟹江西保育所": ["10:39", "11:39", "13:39", "14:39"],
                "西之森": ["10:41", "11:41", "13:41", "14:41"],
                "山吉": ["10:42", "11:42", "13:42", "14:42"],
                "西大海用": ["10:44", "11:44", "13:44", "14:44"],
                "須西小学校": ["10:46", "11:46", "13:46", "14:46"],
                "宝三宝蔵": ["10:48", "11:48", "13:48", "14:48"],
                "舟入四丁目": ["10:50", "11:50", "13:50", "14:50"],
                "舟入二丁目": ["10:52", "11:52", "13:52", "14:52"],
                "ヨシヅヤ前": ["10:53", "11:53", "13:53", "14:53"],
                "今西": ["10:55", "11:55", "13:55", "14:55"],
                "JR蟹江駅北口": ["10:58", "11:58", "13:58", "14:58"]
            }
        };

        // Google Sheets API の URL (実際のアプリでは使用)
        const SPREADSHEET_URL = 'https://docs.google.com/spreadsheets/d/13MQSno_jn1XYaPkmeeuwZzRsa62I9pVeiPXjS7AKC5I/edit?gid=0';
        
        // 天気 API の URL と API キー (OpenWeatherMap の例)
        const WEATHER_API_URL = 'https://api.openweathermap.org/data/2.5/weather';
        const WEATHER_API_KEY = 'YOUR_API_KEY'; // 実際には自分の API キーに置き換えてください
        const CITY_ID = '1851357'; // 蟹江町の City ID

        // DOM 要素の参照を取得
        const currentTimeElement = document.getElementById('current-time');
        const busStatusElement = document.getElementById('bus-status');
        const nextBusElement = document.getElementById('next-bus');
        const refreshButton = document.getElementById('refresh-btn');
        const busStopSelect = document.getElementById('bus-stop-select');

        // アプリケーションの初期化
        document.addEventListener('DOMContentLoaded', () => {
            // バス停選択リストを初期化
            initializeBusStopSelect();
            
            updateCurrentTime();
            updateBusInfo();
            
            // 更新ボタンのイベントリスナー
            refreshButton.addEventListener('click', updateBusInfo);
            
            // バス停選択変更時のイベントリスナー
            busStopSelect.addEventListener('change', updateBusInfo);
            
            // 1分ごとに時刻を更新
            setInterval(updateCurrentTime, 60000);
            
            // 5分ごとにバス情報を更新
            setInterval(updateBusInfo, 300000);
        });

        // バス停選択リストを初期化する関数
        function initializeBusStopSelect() {
            busStopSelect.innerHTML = '';
            
            busStops.forEach(stop => {
                const option = document.createElement('option');
                option.value = stop;
                option.textContent = stop;
                busStopSelect.appendChild(option);
            });
            
            // デフォルトで蟹江町役場を選択
            busStopSelect.value = "蟹江町役場";
        }

        // 現在時刻を更新する関数
        function updateCurrentTime() {
            const now = new Date();
            const hours = now.getHours().toString().padStart(2, '0');
            const minutes = now.getMinutes().toString().padStart(2, '0');
            const dayOfWeek = weekdays[now.getDay()];
            
            currentTimeElement.textContent = `${hours}:${minutes}（${dayOfWeek}曜日）`;
        }

        // バス情報を更新する関数
        async function updateBusInfo() {
            busStatusElement.textContent = "情報を取得中...";
            nextBusElement.textContent = "次のバス情報を計算中...";
            
            try {
                // 実際のアプリでは以下の行のコメントを解除してAPIからデータを取得
                // const schedule = await fetchBusSchedule();
                // const weatherInfo = await fetchWeatherInfo();

                // デモ用に仮のデータを使用
                const schedule = busSchedule;
                const weatherInfo = { isOperating: true };
                
                const now = new Date();
                const todayStr = now.toISOString().split('T')[0]; // YYYY-MM-DD 形式
                const selectedBusStop = busStopSelect.value;
                
                // 祝日かどうかチェック
                const isHoliday = holidays.includes(todayStr);
                
                // 運行状況の判定
                let operatingStatus = true;
                let statusReason = "";
                let scheduleType = "weekday";
                
                if (isHoliday) {
                    scheduleType = "holiday";
                    // 祝日でも運行する場合があるので、祝日スケジュールを確認
                    if (schedule.holiday[selectedBusStop] && schedule.holiday[selectedBusStop].length > 0) {
                        operatingStatus = true;
                    } else {
                        operatingStatus = false;
                        statusReason = "祝日のため";
                    }
                } else if (!weatherInfo.isOperating) {
                    operatingStatus = false;
                    statusReason = "悪天候のため";
                } else if (now.getDay() === 0) {
                    // 日曜日
                    scheduleType = "holiday";
                    if (schedule.holiday[selectedBusStop] && schedule.holiday[selectedBusStop].length > 0) {
                        operatingStatus = true;
                    } else {
                        operatingStatus = false;
                        statusReason = "日曜日のため";
                    }
                } else if (now.getDay() === 6) {
                    // 土曜日
                    scheduleType = "saturday";
                    if (schedule.saturday[selectedBusStop] && schedule.saturday[selectedBusStop].length > 0) {
                        operatingStatus = true;
                    } else {
                        operatingStatus = false;
                        statusReason = "土曜日のため";
                    }
                }
                
                // 選択されたバス停のスケジュールを取得
                const busStopSchedule = schedule[scheduleType][selectedBusStop] || [];
                
                // 次のバスの発車時刻を計算
                const nextBusInfo = calculateNextBusTime(busStopSchedule, now);
                
                // 運行状況と次のバス情報の表示を更新
                if (!operatingStatus) {
                    // 運休の場合
                    busStatusElement.textContent = `本日は運休です（${statusReason}）`;
                    busStatusElement.className = "bus-status not-operating";
                    nextBusElement.textContent = "運行予定はありません";
                } else if (nextBusInfo.hasNextBus) {
                    // 次のバスがある場合
                    busStatusElement.textContent = "現在運行中です";
                    busStatusElement.className = "bus-status operating";
                    nextBusElement.textContent = `次のバスは${nextBusInfo.minutesUntilNextBus}分後（${nextBusInfo.nextBusTimeStr}）に発車します`;
                } else {
                    // 運行中だが本日の運行は終了した場合
                    busStatusElement.textContent = "現在運行中です";
                    busStatusElement.className = "bus-status operating";
                    nextBusElement.textContent = "本日の運行は終了しました";
                }
            } catch (error) {
                console.error('バス情報の取得に失敗しました:', error);
                busStatusElement.textContent = "情報の取得に失敗しました";
                busStatusElement.className = "bus-status not-operating";
                nextBusElement.textContent = "インターネット接続を確認してください";
            }
        }

        // バススケジュールを API から取得する関数
        async function fetchBusSchedule() {
            try {
                // 実際のプロジェクトでは、Google Sheets APIを使用してデータを取得
                // このサンプルでは省略します
                
                return busSchedule; // サンプルデータを返す
            } catch (error) {
                console.error('スケジュールの取得中にエラーが発生しました:', error);
                return busSchedule; // エラー時はサンプルデータを返す
            }
        }

        // 天気情報を API から取得する関数
        async function fetchWeatherInfo() {
            try {
                // 実際のプロジェクトでは、OpenWeatherMap APIなどを使用
                // このサンプルでは省略します
                
                return { isOperating: true }; // サンプルデータを返す
            } catch (error) {
                console.error('天気情報の取得中にエラーが発生しました:', error);
                return { isOperating: true }; // エラー時はデフォルトで運行中と仮定
            }
        }

        // 次のバスの発車時刻を計算する関数
        function calculateNextBusTime(busStopSchedule, currentTime) {
            const now = currentTime || new Date();
            const currentHours = now.getHours();
            const currentMinutes = now.getMinutes();
            const currentTimeStr = `${currentHours.toString().padStart(2, '0')}:${currentMinutes.toString().padStart(2, '0')}`;
            
            // 次のバスを探す
            for (const timeStr of busStopSchedule) {
                const [hours, minutes] = timeStr.split(':').map(Number);
                
                // 現在時刻より後の時間かチェック
                if (hours > currentHours || (hours === currentHours && minutes > currentMinutes)) {
                    const busTime = new Date(now);
                    busTime.setHours(hours, minutes, 0, 0);
                    
                    // 次のバスまでの分数を計算
                    const minutesUntilNextBus = Math.ceil((busTime - now) / 60000);
                    
                    return {
                        hasNextBus: true,
                        nextBusTime: busTime,
                        nextBusTimeStr: timeStr,
                        minutesUntilNextBus: minutesUntilNextBus
                    };
                }
            }
            
            // その日の最後のバスが既に出発している場合
            return {
                hasNextBus: false
            };
        }

        // PWA 対応のためのサービスワーカー登録（オプション）
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/service-worker.js')
                    .then(registration => {
                        console.log('ServiceWorker registration successful');
                    })
                    .catch(error => {
                        console.log('ServiceWorker registration failed:', error);
                    });
            });
        }
    </script>
</body>
</html>