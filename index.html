<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>èŸ¹æ±Ÿç”ºãŠæ•£æ­©ãƒã‚¹</title>
    <style>
        body {
            font-family: 'Helvetica Neue', Arial, sans-serif;
            max-width: 480px;
            margin: 0 auto;
            padding: 16px;
            background-color: #f5f5f5;
            color: #333;
        }
        .header {
            text-align: center;
            margin-bottom: 24px;
        }
        .header h1 {
            margin: 0;
            color: #2c3e50;
            font-size: 24px;
        }
        .card {
            background-color: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 16px;
        }
        .time-display {
            font-size: 28px;
            font-weight: bold;
            text-align: center;
            margin-bottom: 8px;
        }
        .day-display {
            text-align: center;
            font-size: 18px;
            color: #666;
            margin-bottom: 16px;
        }
        .next-bus {
            font-size: 24px;
            text-align: center;
            margin: 24px 0;
            padding: 16px;
            background-color: #f8f9fa;
            border-radius: 8px;
        }
        .status {
            text-align: center;
            font-size: 20px;
            margin: 16px 0;
            padding: 12px;
            border-radius: 8px;
        }
        .running {
            background-color: #d4edda;
            color: #155724;
        }
        .not-running {
            background-color: #f8d7da;
            color: #721c24;
        }
        .day-ended {
            background-color: #cce5ff;
            color: #004085;
        }
        .route-selector {
            display: flex;
            justify-content: center;
            margin: 16px 0;
        }
        .route-btn {
            padding: 10px 20px;
            margin: 0 8px;
            border: none;
            border-radius: 20px;
            font-size: 16px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .route-orange {
            background-color: #FF9800;
            color: white;
        }
        .route-green {
            background-color: #4CAF50;
            color: white;
        }
        .route-purple {
            background-color: #b39ddb;
            color: white;
            color: white;
        }
        .route-btn.active {
            box-shadow: 0 0 0 3px rgba(0, 0, 0, 0.2);
            font-weight: bold;
        }
        .refresh-btn {
            display: block;
            width: 100%;
            padding: 12px;
            margin-top: 16px;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .refresh-btn:hover {
            background-color: #2980b9;
        }
        .refresh-btn:active {
            background-color: #1f6aa5;
        }
        .timetable {
            width: 100%;
            margin-top: 24px;
            border-collapse: collapse;
        }
        .timetable th, .timetable td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: center;
        }
        .timetable th {
            background-color: #f2f2f2;
        }
        .timetable .next {
            background-color: #fff9c4;
            font-weight: bold;
        }
        .loading {
            text-align: center;
            margin: 20px 0;
            color: #666;
        }
        .error-message {
            color: #721c24;
            background-color: #f8d7da;
            padding: 12px;
            border-radius: 8px;
            margin: 16px 0;
            text-align: center;
        }
        .footer {
            margin-top: 24px;
            text-align: center;
            font-size: 12px;
            color: #666;
        }
        @media (prefers-color-scheme: dark) {
            body {
                background-color: #121212;
                color: #e0e0e0;
            }
            .card {
                background-color: #1e1e1e;
                box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
            }
            .header h1 {
                color: #e0e0e0;
            }
            .next-bus {
                background-color: #2a2a2a;
            }
            .day-display {
                color: #aaa;
            }
            .running {
                background-color: #1e3a2b;
                color: #75b798;
            }
            .not-running {
                background-color: #3b1e25;
                color: #ea868f;
            }
            .day-ended {
                background-color: #1a3b5c;
                color: #9ec5fe;
            }
            .timetable th {
                background-color: #2a2a2a;
            }
            .timetable td {
                border-color: #444;
            }
            .timetable .next {
                background-color: #3d3c17;
            }
            .error-message {
                background-color: #3b1e25;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>èŸ¹æ±Ÿç”ºãŠæ•£æ­©ãƒã‚¹</h1>
    </div>

    <div class="card">
        <div class="time-display" id="current-time">--:--</div>
        <div class="day-display" id="current-day">-æ›œæ—¥</div>
        
        <div class="route-selector">
            <button class="route-btn route-orange active" id="orange-route">ã‚ªãƒ¬ãƒ³ã‚¸ã‚³ãƒ¼ã‚¹</button>
            <button class="route-btn route-green" id="green-route">ã‚°ãƒªãƒ¼ãƒ³ã‚³ãƒ¼ã‚¹</button>
            <button class="route-btn route-purple" id="purple-route" style="display: none;">æ—¥æ›œã‚³ãƒ¼ã‚¹</button>
        </div>
        
        <div id="status-container">
            <div class="status" id="status-display">èª­ã¿è¾¼ã¿ä¸­...</div>
            <div class="next-bus" id="next-bus-display">æ¬¡ã®ãƒã‚¹ã‚’ç¢ºèªä¸­...</div>
        </div>

        <div id="error-container" style="display: none;" class="error-message"></div>
        
        <div id="loading" class="loading">æ™‚åˆ»è¡¨ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...</div>
        
        <button class="refresh-btn" id="refresh-btn">æƒ…å ±ã‚’æ›´æ–°ã™ã‚‹</button>
    </div>
    
    <div class="card" id="timetable-container" style="display: none;">
        <h2>æœ¬æ—¥ã®æ™‚åˆ»è¡¨</h2>
        <table class="timetable" id="timetable">
            <!-- æ™‚åˆ»è¡¨ãŒã“ã“ã«å‹•çš„ã«æŒ¿å…¥ã•ã‚Œã¾ã™ -->
        </table>
    </div>

    <div class="footer">
        <p>â€»ç¥æ—¥ãƒ»è’å¤©æ™‚ã¯é‹ä¼‘ã™ã‚‹å ´åˆãŒã‚ã‚Šã¾ã™</p>
        <p>Â© èŸ¹æ±Ÿç”ºãŠæ•£æ­©ãƒã‚¹ã‚¢ãƒ—ãƒª</p>
    </div>

    <script>
        // å®šæ•°ã¨è¨­å®š
        const SPREADSHEET_ID = '13MQSno_jn1XYaPkmeeuwZzRsa62I9pVeiPXjS7AKC5I';
        const SHEET_NAME = 'Sheet1';
        
        // Google Apps Script Webã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒ‡ãƒ—ãƒ­ã‚¤å…ˆURLï¼ˆCORSå¯¾å¿œã®ãŸã‚ï¼‰
        // æ³¨: å®Ÿéš›ã®ä½¿ç”¨å‰ã«ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™
        const GAS_WEB_APP_URL = 'https://script.google.com/macros/s/YOUR_DEPLOYMENT_ID/exec';
        
        const WEATHER_API_KEY = 'aedbab52747a52984fdcedcb196bc105';
        const WEATHER_CITY_ID = '1851604'; // èŸ¹æ±Ÿç”ºã®éƒ½å¸‚ID
        
        // DOMè¦ç´ ã®å‚ç…§ã‚’ä¿æŒ
        const currentTimeEl = document.getElementById('current-time');
        const currentDayEl = document.getElementById('current-day');
        const nextBusEl = document.getElementById('next-bus-display');
        const statusEl = document.getElementById('status-display');
        const refreshBtn = document.getElementById('refresh-btn');
        const loadingEl = document.getElementById('loading');
        const timetableContainerEl = document.getElementById('timetable-container');
        const timetableEl = document.getElementById('timetable');
        const errorContainerEl = document.getElementById('error-container');
        const orangeRouteBtn = document.getElementById('orange-route');
        const greenRouteBtn = document.getElementById('green-route');
        const purpleRouteBtn = document.getElementById('purple-route');
        
        // ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®çŠ¶æ…‹
        let state = {
            currentRoute: 'orange', // 'orange' ã¾ãŸã¯ 'green'
            isSundayCourse: false,
            isHoliday: false,
            isSuspendedDueToWeather: false,
            busSchedule: null,
            nextBusDeparture: null,
            minutesToNextBus: null,
            operatingStatus: 'unknown' // 'running', 'not-running', 'day-ended'
        };
        
        // åˆæœŸåŒ–é–¢æ•°
        async function initApp() {
    try {
        console.log("initApp() é–‹å§‹");
        updateCurrentTime();
        setInterval(updateCurrentTime, 1000);

        // ãƒ«ãƒ¼ãƒˆãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
        orangeRouteBtn.addEventListener('click', () => setRoute('orange'));
        greenRouteBtn.addEventListener('click', () => setRoute('green'));

        // æ›´æ–°ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
        refreshBtn.addEventListener('click', refreshData);

        console.log("åˆå›ãƒ‡ãƒ¼ã‚¿å–å¾—é–‹å§‹");
        await refreshData();
        console.log("åˆå›ãƒ‡ãƒ¼ã‚¿å–å¾—å®Œäº†");

        // 60ç§’ã”ã¨ã«æƒ…å ±ã‚’è‡ªå‹•æ›´æ–°
        setInterval(updateNextBusInfo, 60000);

        // æ¯æ—¥0æ™‚0åˆ†ã«ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°
        setInterval(refreshDataAtMidnight, 86400000); // 24æ™‚é–“ã”ã¨ã«å®Ÿè¡Œ (ãƒŸãƒªç§’)

        console.log("initApp() å®Œäº†");
    } catch (error) {
        console.error("ã‚¢ãƒ—ãƒªåˆæœŸåŒ–ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:", error);
        errorContainerEl.textContent = `ã‚¨ãƒ©ãƒ¼: ã‚¢ãƒ—ãƒªã®åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸ`;
        errorContainerEl.style.display = 'block';
    }
}

        // 0æ™‚0åˆ†ã«ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°ã™ã‚‹é–¢æ•°
        function refreshDataAtMidnight() {
            const now = new Date();
            const midnight = new Date(now.getFullYear(), now.getMonth(), now.getDate() + 1, 0, 0, 0); // æ¬¡ã®æ—¥ã®0æ™‚0åˆ†
            const timeUntilMidnight = midnight.getTime() - now.getTime();

            setTimeout(() => {
                console.log("0æ™‚ã«ãªã‚Šã¾ã—ãŸã€‚ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°ã—ã¾ã™ã€‚");
                refreshData();
                // ä»¥é™ã‚‚æ¯æ—¥0æ™‚ã«æ›´æ–°ã™ã‚‹ãŸã‚ã«ã€å†åº¦è¨­å®š
                setInterval(refreshDataAtMidnight, 86400000);
            }, timeUntilMidnight);
        }

        // ç¾åœ¨æ™‚åˆ»ã¨æ›œæ—¥ã®æ›´æ–°
        function updateCurrentTime() {
            const now = new Date();
            const hours = now.getHours().toString().padStart(2, '0');
            const minutes = now.getMinutes().toString().padStart(2, '0');
            const dayIndex = now.getDay();
            const days = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'];
            
            currentTimeEl.textContent = `${hours}:${minutes}`;
            currentDayEl.textContent = `ï¼ˆ${days[dayIndex]}æ›œæ—¥ï¼‰`;
            
            // ç¾åœ¨æ™‚åˆ»ãŒå¤‰ã‚ã£ãŸã®ã§ã€æ¬¡ã®ãƒã‚¹æƒ…å ±ã‚‚æ›´æ–°
            if (state.busSchedule) {
                updateNextBusInfo();
            }
        }
        
        // ãƒ«ãƒ¼ãƒˆåˆ‡ã‚Šæ›¿ãˆ
        function setRoute(route) {
            state.currentRoute = route;
            
            // ãƒœã‚¿ãƒ³ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–çŠ¶æ…‹ã‚’æ›´æ–°
            if (route === 'orange') {
                orangeRouteBtn.classList.add('active');
                greenRouteBtn.classList.remove('active');
            } else {
                orangeRouteBtn.classList.remove('active');
                greenRouteBtn.classList.add('active');
            }
            
            // æ¬¡ã®ãƒã‚¹æƒ…å ±ã‚’æ›´æ–°
            updateNextBusInfo();
            updateTimetableDisplay();
        }
        
        // ãƒ‡ãƒ¼ã‚¿ã®æ›´æ–°
        async function refreshData() {
            try {
                errorContainerEl.style.display = 'none';
                loadingEl.style.display = 'block';
                
                // 1. ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‹ã‚‰ãƒã‚¹ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’å–å¾—
                await fetchBusSchedule();
                
                // 2. ç¥æ—¥ã‹ã©ã†ã‹ã‚’ç¢ºèª
                await checkIfHoliday();
                
                // 3. æ°—è±¡çŠ¶æ³ã‚’ç¢ºèªï¼ˆå¤©å€™ã«ã‚ˆã‚‹é‹ä¼‘åˆ¤æ–­ï¼‰
                await checkWeatherConditions();
                
                // 4. æ¬¡ã®ãƒã‚¹æƒ…å ±ã‚’æ›´æ–°
                updateNextBusInfo();
                
                // 5. æ™‚åˆ»è¡¨ã‚’è¡¨ç¤º
                updateTimetableDisplay();
                
                loadingEl.style.display = 'none';
                timetableContainerEl.style.display = 'block';
            } catch (error) {
                console.error('ãƒ‡ãƒ¼ã‚¿æ›´æ–°ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:', error);
                errorContainerEl.textContent = `ã‚¨ãƒ©ãƒ¼: ${error.message}`;
                errorContainerEl.style.display = 'block';
                loadingEl.style.display = 'none';
            }
        }
       
        // ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ï¼ˆGASã®Web APIã‚’ä½¿ç”¨ï¼‰
        async function fetchBusSchedule() {
    try {
        // Google Apps Script (GAS) ã®ãƒ‡ãƒ—ãƒ­ã‚¤URL
        const url = 'https://script.google.com/macros/s/AKfycbwIAPY3OFzCBDU388qWGjqHhSXWa_8Qvj5MTt-8MWFCESKoK5Iw4NnQ402moWiByV6Ang/exec'; // GASã®URLã«å¤‰æ›´

        const response = await fetch(url);
        if (!response.ok) {
            throw new Error(`HTTPã‚¨ãƒ©ãƒ¼: ${response.status}`);
        }

        const data = await response.json();
        console.log("å–å¾—ã—ãŸãƒ‡ãƒ¼ã‚¿:", data);

        // ãƒ‡ãƒ¼ã‚¿ã‚’ state ã«æ ¼ç´
        state.busSchedule = {
            orange: {
                weekday: data.orange.weekday,
                saturday: data.orange.saturday,
                holiday: data.holyday.orange // ğŸ”¹ "holyday" ã‚·ãƒ¼ãƒˆã®ã‚ªãƒ¬ãƒ³ã‚¸ãƒ«ãƒ¼ãƒˆã‚’æ ¼ç´
            },
            green: {
                weekday: data.green.weekday,
                saturday: data.green.saturday,
                holiday: data.holyday.green // ğŸ”¹ "holyday" ã‚·ãƒ¼ãƒˆã®ã‚°ãƒªãƒ¼ãƒ³ãƒ«ãƒ¼ãƒˆã‚’æ ¼ç´
            }
        };

        console.log("ãƒã‚¹ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ãŒæ›´æ–°ã•ã‚Œã¾ã—ãŸ:", state.busSchedule);
        return state.busSchedule;
    } catch (error) {
        console.error('ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ:', error);
        errorContainerEl.textContent = `ã‚¨ãƒ©ãƒ¼: ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ`;
        errorContainerEl.style.display = 'block';
        loadingEl.style.display = 'none';
        return null;
    }
}
        
        // ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰æ™‚åˆ»è¡¨ã‚’æŠ½å‡ºã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
        function extractTimeSchedule(rows, routeType, dayType) {
            // rows, routeType, dayTypeã«åŸºã¥ã„ã¦ãƒ‡ãƒ¼ã‚¿ã‚’æŠ½å‡º
            // ã“ã®é–¢æ•°ã¯å®Ÿéš›ã®ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®æ§‹é€ ã«åˆã‚ã›ã¦èª¿æ•´ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™
            
            // ä»®å®Ÿè£…ï¼ˆå®Ÿéš›ã®ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã«åˆã‚ã›ã¦å¤‰æ›´ï¼‰
            const timeArray = [];
            
            try {
                for (const row of rows) {
                    // è¡Œã®ãƒ‡ãƒ¼ã‚¿ã‚’ç¢ºèªã—ã€æ¡ä»¶ã«ä¸€è‡´ã™ã‚‹æ™‚é–“ã‚’æŠ½å‡º
                    const cellData = row.c;
                    if (cellData && cellData.length >= 3) {
                        // ä¾‹: 1åˆ—ç›®ãŒãƒ«ãƒ¼ãƒˆã‚¿ã‚¤ãƒ—ã€2åˆ—ç›®ãŒæ›œæ—¥ã‚¿ã‚¤ãƒ—ã€3åˆ—ç›®ãŒæ™‚åˆ»
                        const rowRouteType = cellData[0]?.v;
                        const rowDayType = cellData[1]?.v;
                        const time = cellData[2]?.v;
                        
                        if (rowRouteType === routeType && rowDayType === dayType && time) {
                            timeArray.push(time);
                        }
                    }
                }
                return timeArray.sort();
            } catch (e) {
                console.error('æ™‚åˆ»è¡¨ãƒ‡ãƒ¼ã‚¿ã®æŠ½å‡ºä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:', e);
                return [];
            }
        }
        
        // ç¥æ—¥ã‹ã©ã†ã‹ã‚’ç¢ºèª
        // ç¥æ—¥ã‹ã©ã†ã‹ã‚’ç¢ºèªï¼ˆæ—¥æ›œæ—¥ã¯ç¥æ—¥æ‰±ã„ã›ãšåŒºåˆ¥ã™ã‚‹ï¼‰
        async function checkIfHoliday() {
        try {
            const today = new Date();
            const formattedDate = `${today.getFullYear()}-${(today.getMonth() + 1).toString().padStart(2, '0')}-${today.getDate().toString().padStart(2, '0')}`;
        
            // ç°¡æ˜“å®Ÿè£…ï¼šç¥æ—¥APIã®ä»£ã‚ã‚Šã«æ‰‹å‹•ã§æ—¥ä»˜ãƒªã‚¹ãƒˆã‚’ç®¡ç†
            const holidays = [
                "2025-01-01", "2025-02-11", "2025-03-21", "2025-04-29",
                "2025-05-03", "2025-05-05", "2025-07-15", "2025-08-11", "2025-09-16", "2025-09-23", "2025-10-14",
                "2025-11-03", "2025-11-23", "2025-12-23"
            ];

            state.isSunday = today.getDay() === 0;  // æ—¥æ›œæ—¥åˆ¤å®š
            state.isHoliday = holidays.includes(formattedDate) && !state.isSunday;  // ç¥æ—¥åˆ¤å®šï¼ˆæ—¥æ›œæ—¥ã¯é™¤å¤–ï¼‰
        
            return { isHoliday: state.isHoliday, isSunday: state.isSunday };
        } catch (error) {
            console.error('ç¥æ—¥ç¢ºèªä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:', error);
            state.isHoliday = false;
            state.isSunday = false;
            return { isHoliday: false, isSunday: false };
        }
    }
        
        // æ°—è±¡æ¡ä»¶ã‚’ç¢ºèª
        async function checkWeatherConditions() {
            try {
                // OpenWeatherMap APIã‚’ä½¿ç”¨
                const response = await fetch(`https://api.openweathermap.org/data/2.5/weather?id=${WEATHER_CITY_ID}&appid=${WEATHER_API_KEY}&units=metric&lang=ja`);
                
                if (!response.ok) {
                    throw new Error('æ°—è±¡ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
                }
                
                const data = await response.json();
                const weatherId = data.weather[0].id;
                
                // è±ªé›¨ï¼ˆå¤§é›¨ï¼‰ã€è±ªé›ªï¼ˆå¤§é›ªï¼‰ã€å°é¢¨ãªã©ã®è­¦å ±æ¡ä»¶ã‚’ãƒã‚§ãƒƒã‚¯
                // weatherIdã®ç¯„å›²ã«åŸºã¥ã„ã¦é‹ä¼‘åˆ¤æ–­ï¼ˆè¦èª¿æ•´ï¼‰
                state.isSuspendedDueToWeather = 
                    (weatherId >= 200 && weatherId < 300) || // é›·é›¨
                    (weatherId >= 500 && weatherId < 600 && data.rain && data.rain['1h'] > 20) || // å¤§é›¨ (1æ™‚é–“ã«20mmä»¥ä¸Š)
                    (weatherId >= 600 && weatherId < 700 && data.snow && data.snow['1h'] > 10) || // å¤§é›ª (1æ™‚é–“ã«10cmä»¥ä¸Š)
                    (weatherId >= 781 && weatherId < 782); // ç«œå·»
                
                return state.isSuspendedDueToWeather;
            } catch (error) {
                console.error('æ°—è±¡æ¡ä»¶ç¢ºèªä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:', error);
                // ã‚¨ãƒ©ãƒ¼ãŒã‚ã£ã¦ã‚‚å‡¦ç†ã‚’ç¶šè¡Œ
                state.isSuspendedDueToWeather = false;
                return false;
            }
        }
        
            // æ¬¡ã®ãƒã‚¹ç™ºè»Šæ™‚åˆ»ã‚’è¨ˆç®—
        function updateNextBusInfo() {
            if (!state.busSchedule) return;

            const now = new Date();
            const day = now.getDay(); // 0:æ—¥, 1:æœˆ, ... 6:åœŸ
            const currentHour = now.getHours();
            const currentMinute = now.getMinutes();
            const currentTimeValue = currentHour * 60 + currentMinute; // åˆ†å˜ä½ã§ã®ç¾åœ¨æ™‚åˆ»

            // é‹è¡Œã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã®é¸æŠï¼ˆå¹³æ—¥ã€åœŸæ›œã€æ—¥æ›œãƒ»ç¥æ—¥ï¼‰
            let schedule;
            let scheduleType = 'å¹³æ—¥';

        if (state.isSunday) {
            schedule = state.busSchedule[state.currentRoute].holiday; // æ—¥æ›œæ—¥å°‚ç”¨ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«
            scheduleType = 'æ—¥æ›œã‚³ãƒ¼ã‚¹';
        } else if (state.isHoliday) {
            updateStatus('not-running', 'æœ¬æ—¥ã¯ç¥æ—¥ã®ãŸã‚é‹ä¼‘ã§ã™');
            return;
        } else {
            schedule = state.busSchedule[state.currentRoute].weekday;
        }

        if (!schedule || schedule.length === 0) {
            updateStatus('not-running', `æœ¬æ—¥ã®é‹è¡Œã¯ã‚ã‚Šã¾ã›ã‚“`);
            return;
        }

        let nextBusTime = null;
        let minutesToNext = Infinity;

        for (const timeStr of schedule) {
            const [hours, minutes] = timeStr.split(':').map(Number);
            const busTimeValue = hours * 60 + minutes; // åˆ†å˜ä½ã§ã®ãƒã‚¹æ™‚åˆ»
            const diff = busTimeValue - currentTimeValue;

            if (diff > 0 && diff < minutesToNext) {
                minutesToNext = diff;
                nextBusTime = timeStr;
            }
        }

        if (!nextBusTime) {
            const now = new Date();
            const currentHour = now.getHours();

            if (currentHour < 24) {
                updateStatus('day-ended', 'æœ¬æ—¥ã®é‹è¡Œã¯çµ‚äº†ã—ã¾ã—ãŸ');
                return;
            }
        }

        state.nextBusDeparture = nextBusTime;
        state.minutesToNextBus = minutesToNext;

        updateStatus('running', `æœ¬æ—¥ã¯${scheduleType}ã§é‹è¡Œã—ã¦ã„ã¾ã™`);
        nextBusEl.textContent = `æ¬¡ã®ãƒã‚¹ã¯ ${nextBusTime} ï¼ˆã‚ã¨${minutesToNext}åˆ†ï¼‰`;
    }
        
        // é‹è¡ŒçŠ¶æ³è¡¨ç¤ºã‚’æ›´æ–°
        function updateStatus(statusClass, statusText) {
            state.operatingStatus = statusClass;
            statusEl.className = `status ${statusClass}`;
            statusEl.textContent = statusText;
            nextBusEl.textContent = (statusClass === 'not-running') ? 'æœ¬æ—¥ã¯é‹ä¼‘ã§ã™' : (statusClass === 'day-ended') ? 'æœ¬æ—¥ã®é‹è¡Œã¯çµ‚äº†ã—ã¾ã—ãŸ' : nextBusEl.textContent;

            // æ™‚åˆ»è¡¨ã‚’å¸¸ã«è¡¨ç¤ºã™ã‚‹
            timetableContainerEl.style.display = 'block';
        }

        // æ™‚åˆ»è¡¨ã‚’è¡¨ç¤º
        function updateTimetableDisplay() {
            if (!state.busSchedule) return;

            const now = new Date();
            const day = now.getDay();

            // é‹è¡Œã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã®é¸æŠ
            let schedule;
            let scheduleType;

            if (state.isHoliday) {
                schedule = state.busSchedule[state.currentRoute].holiday;
                scheduleType = 'ç¥æ—¥';
            } else if (state.isSunday) {
                schedule = state.busSchedule[state.currentRoute].holiday;
                scheduleType = 'æ—¥æ›œ';
            } else if (day === 6) {
                schedule = state.busSchedule[state.currentRoute].saturday;
                scheduleType = 'åœŸæ›œ';
            } else {
                schedule = state.busSchedule[state.currentRoute].weekday;
                scheduleType = 'å¹³æ—¥';
            }

            // æ™‚åˆ»è¡¨ã®ãƒ˜ãƒƒãƒ€ãƒ¼
            let tableHTML = `
                <tr>
                    <th colspan="2">${state.currentRoute === 'orange' ? 'ã‚ªãƒ¬ãƒ³ã‚¸' : 'ã‚°ãƒªãƒ¼ãƒ³'}ã‚³ãƒ¼ã‚¹ï¼ˆ${scheduleType}ï¼‰</th>
                </tr>
                <tr>
                    <th>å‡ºç™ºæ™‚åˆ»</th>
                    <th>çŠ¶æ…‹</th>
                </tr>
            `;

            // æ™‚åˆ»è¡¨ã®å†…å®¹
            for (const timeStr of schedule) {
                const [hours, minutes] = timeStr.split(':').map(Number);
                const busTimeValue = hours * 60 + minutes;

                let status = '';
                let rowClass = '';

                const now = new Date();
                const currentHour = now.getHours();
                const currentMinute = now.getMinutes();
                const currentTimeValue = currentHour * 60 + currentMinute;

                if (busTimeValue < currentTimeValue) {
                    status = 'å‡ºç™ºæ¸ˆã¿';
                } else if (timeStr === state.nextBusDeparture) {
                    status = `ã‚ã¨${state.minutesToNextBus}åˆ†`;
                    rowClass = 'next';
                } else {
                    const diff = busTimeValue - currentTimeValue;
                    status = `ã‚ã¨${diff}åˆ†`;
                }

                tableHTML += `
                    <tr class="${rowClass}">
                        <td>${timeStr}</td>
                        <td>${status}</td>
                    </tr>
                `;
            }

            timetableEl.innerHTML = tableHTML;
        }
        
        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«ã‚¢ãƒ—ãƒªã‚’åˆæœŸåŒ–
        window.addEventListener('DOMContentLoaded', () => {
            initApp();

            // åˆæœŸè¡¨ç¤ºè¨­å®š
            updateRouteButtonVisibility();

            // ç´«ãƒœã‚¿ãƒ³ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸã¨ãã®å‡¦ç†
            purpleRouteBtn.addEventListener('click', () => {
                setRoute('purple');
            });
        });

        function updateRouteButtonVisibility() {
            const now = new Date();
            const dayIndex = now.getDay();
            const isNotRunning = state.operatingStatus === 'not-running' || state.operatingStatus === 'day-ended';

            orangeRouteBtn.style.display = 'none';
            greenRouteBtn.style.display = 'none';
            purpleRouteBtn.style.display = 'none';

            if (isNotRunning) {
                orangeRouteBtn.style.display = 'none';
                greenRouteBtn.style.display = 'none';
                purpleRouteBtn.style.display = 'none';
            } else if (dayIndex === 0) { // æ—¥æ›œæ—¥
                purpleRouteBtn.style.display = 'inline-block';
                orangeRouteBtn.style.display = 'none';
                greenRouteBtn.style.display = 'none';
            } else { // å¹³æ—¥
                orangeRouteBtn.style.display = 'inline-block';
                greenRouteBtn.style.display = 'inline-block';
                purpleRouteBtn.style.display = 'none';
            }
        }

         // ãƒ«ãƒ¼ãƒˆåˆ‡ã‚Šæ›¿ãˆé–¢æ•°ã‚’ä¿®æ­£
        function setRoute(route) {
            state.currentRoute = route;
            state.isSundayCourse = route === 'purple';

            updateRouteButtonVisibility();
            // æ¬¡ã®ãƒã‚¹æƒ…å ±ã‚’æ›´æ–°
            updateNextBusInfo();
            updateTimetableDisplay();
        }

    </script>
</body>
</html>
