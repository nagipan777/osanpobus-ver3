<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>蟹江町お散歩バス</title>
    <style>
        body {
            font-family: 'Helvetica Neue', Arial, sans-serif;
            max-width: 480px;
            margin: 0 auto;
            padding: 16px;
            background-color: #f5f5f5;
            color: #333;
        }
        .header {
            text-align: center;
            margin-bottom: 24px;
        }
        .header h1 {
            margin: 0;
            color: #2c3e50;
            font-size: 24px;
        }
        .card {
            background-color: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 16px;
        }
        .time-display {
            font-size: 28px;
            font-weight: bold;
            text-align: center;
            margin-bottom: 8px;
        }
        .day-display {
            text-align: center;
            font-size: 18px;
            color: #666;
            margin-bottom: 16px;
        }
        .next-bus {
            font-size: 24px;
            text-align: center;
            margin: 24px 0;
            padding: 16px;
            background-color: #f8f9fa;
            border-radius: 8px;
        }
        .status {
            text-align: center;
            font-size: 20px;
            margin: 16px 0;
            padding: 12px;
            border-radius: 8px;
        }
        .running {
            background-color: #d4edda;
            color: #155724;
        }
        .not-running {
            background-color: #f8d7da;
            color: #721c24;
        }
        .day-ended {
            background-color: #cce5ff;
            color: #004085;
        }
        .route-selector {
            display: flex;
            justify-content: center;
            margin: 16px 0;
        }
        .route-btn {
            padding: 10px 20px;
            margin: 0 8px;
            border: none;
            border-radius: 20px;
            font-size: 16px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .route-orange {
            background-color: #FF9800;
            color: white;
        }
        .route-green {
            background-color: #4CAF50;
            color: white;
        }
        .route-btn.active {
            box-shadow: 0 0 0 3px rgba(0, 0, 0, 0.2);
            font-weight: bold;
        }
        .refresh-btn {
            display: block;
            width: 100%;
            padding: 12px;
            margin-top: 16px;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .refresh-btn:hover {
            background-color: #2980b9;
        }
        .refresh-btn:active {
            background-color: #1f6aa5;
        }
        .timetable {
            width: 100%;
            margin-top: 24px;
            border-collapse: collapse;
        }
        .timetable th, .timetable td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: center;
        }
        .timetable th {
            background-color: #f2f2f2;
        }
        .timetable .next {
            background-color: #fff9c4;
            font-weight: bold;
        }
        .loading {
            text-align: center;
            margin: 20px 0;
            color: #666;
        }
        .error-message {
            color: #721c24;
            background-color: #f8d7da;
            padding: 12px;
            border-radius: 8px;
            margin: 16px 0;
            text-align: center;
        }
        .footer {
            margin-top: 24px;
            text-align: center;
            font-size: 12px;
            color: #666;
        }
        @media (prefers-color-scheme: dark) {
            body {
                background-color: #121212;
                color: #e0e0e0;
            }
            .card {
                background-color: #1e1e1e;
                box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
            }
            .header h1 {
                color: #e0e0e0;
            }
            .next-bus {
                background-color: #2a2a2a;
            }
            .day-display {
                color: #aaa;
            }
            .running {
                background-color: #1e3a2b;
                color: #75b798;
            }
            .not-running {
                background-color: #3b1e25;
                color: #ea868f;
            }
            .day-ended {
                background-color: #1a3b5c;
                color: #9ec5fe;
            }
            .timetable th {
                background-color: #2a2a2a;
            }
            .timetable td {
                border-color: #444;
            }
            .timetable .next {
                background-color: #3d3c17;
            }
            .error-message {
                background-color: #3b1e25;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>蟹江町お散歩バス</h1>
    </div>

    <div class="card">
        <div class="time-display" id="current-time">--:--</div>
        <div class="day-display" id="current-day">-曜日</div>
        
        <div class="route-selector">
            <button class="route-btn route-orange active" id="orange-route">オレンジコース</button>
            <button class="route-btn route-green" id="green-route">グリーンコース</button>
        </div>
        
        <div id="status-container">
            <div class="status" id="status-display">読み込み中...</div>
            <div class="next-bus" id="next-bus-display">次のバスを確認中...</div>
        </div>

        <div id="error-container" style="display: none;" class="error-message"></div>
        
        <div id="loading" class="loading">時刻表データを読み込み中...</div>
        
        <button class="refresh-btn" id="refresh-btn">情報を更新する</button>
    </div>
    
    <div class="card" id="timetable-container" style="display: none;">
        <h2>本日の時刻表</h2>
        <table class="timetable" id="timetable">
            <!-- 時刻表がここに動的に挿入されます -->
        </table>
    </div>

    <div class="footer">
        <p>※祝日・荒天時は運休する場合があります</p>
        <p>© 蟹江町お散歩バスアプリ</p>
    </div>

    <script>
        // 定数と設定
        const SPREADSHEET_ID = '13MQSno_jn1XYaPkmeeuwZzRsa62I9pVeiPXjS7AKC5I';
        const SHEET_NAME = 'Sheet1';
        const SPREADSHEET_URL = `https://docs.google.com/spreadsheets/d/${SPREADSHEET_ID}/gviz/tq?tqx=out:csv&sheet=${SHEET_NAME}`;
        
        const WEATHER_API_KEY = 'YOUR_API_KEY'; // 実際のAPIキーに置き換えてください
        const WEATHER_CITY_ID = '1851604'; // 蟹江町の都市ID (OpenWeatherMapの場合)
        
        // DOM要素の参照を保持
        const currentTimeEl = document.getElementById('current-time');
        const currentDayEl = document.getElementById('current-day');
        const nextBusEl = document.getElementById('next-bus-display');
        const statusEl = document.getElementById('status-display');
        const refreshBtn = document.getElementById('refresh-btn');
        const loadingEl = document.getElementById('loading');
        const timetableContainerEl = document.getElementById('timetable-container');
        const timetableEl = document.getElementById('timetable');
        const errorContainerEl = document.getElementById('error-container');
        const orangeRouteBtn = document.getElementById('orange-route');
        const greenRouteBtn = document.getElementById('green-route');
        
        // アプリケーションの状態
        let state = {
            currentRoute: 'orange', // 'orange' または 'green'
            isHoliday: false,
            isSuspendedDueToWeather: false,
            busSchedule: null,
            nextBusDeparture: null,
            minutesToNextBus: null,
            operatingStatus: 'unknown' // 'running', 'not-running', 'day-ended'
        };
        
        // 初期化関数
        async function initApp() {
            updateCurrentTime();
            setInterval(updateCurrentTime, 1000);
            
            // ルートボタンのイベントリスナー
            orangeRouteBtn.addEventListener('click', () => setRoute('orange'));
            greenRouteBtn.addEventListener('click', () => setRoute('green'));
            
            // 更新ボタンのイベントリスナー
            refreshBtn.addEventListener('click', refreshData);
            
            // 初回データ取得
            await refreshData();
            
            // 60秒ごとに情報を自動更新（APIコール多発防止のため）
            setInterval(updateNextBusInfo, 60000);
        }
        
        // 現在時刻と曜日の更新
        function updateCurrentTime() {
            const now = new Date();
            const hours = now.getHours().toString().padStart(2, '0');
            const minutes = now.getMinutes().toString().padStart(2, '0');
            const dayIndex = now.getDay();
            const days = ['日', '月', '火', '水', '木', '金', '土'];
            
            currentTimeEl.textContent = `${hours}:${minutes}`;
            currentDayEl.textContent = `（${days[dayIndex]}曜日）`;
            
            // 現在時刻が変わったので、次のバス情報も更新
            if (state.busSchedule) {
                updateNextBusInfo();
            }
        }
        
        // ルート切り替え
        function setRoute(route) {
            state.currentRoute = route;
            
            // ボタンのアクティブ状態を更新
            if (route === 'orange') {
                orangeRouteBtn.classList.add('active');
                greenRouteBtn.classList.remove('active');
            } else {
                orangeRouteBtn.classList.remove('active');
                greenRouteBtn.classList.add('active');
            }
            
            // 次のバス情報を更新
            updateNextBusInfo();
            updateTimetableDisplay();
        }
        
        // データの更新
        async function refreshData() {
            try {
                errorContainerEl.style.display = 'none';
                loadingEl.style.display = 'block';
                
                // 1. スプレッドシートからバススケジュールを取得
                await fetchBusSchedule();
                
                // 2. 祝日かどうかを確認
                await checkIfHoliday();
                
                // 3. 気象状況を確認（天候による運休判断）
                await checkWeatherConditions();
                
                // 4. 次のバス情報を更新
                updateNextBusInfo();
                
                // 5. 時刻表を表示
                updateTimetableDisplay();
                
                loadingEl.style.display = 'none';
                timetableContainerEl.style.display = 'block';
            } catch (error) {
                console.error('データ更新中にエラーが発生しました:', error);
                errorContainerEl.textContent = `エラー: ${error.message}`;
                errorContainerEl.style.display = 'block';
                loadingEl.style.display = 'none';
            }
        }
        
        // スプレッドシートからデータを取得
        async function fetchBusSchedule() {
            try {
                // モックデータを使用（実際の実装では、Google SheetsのCSV出力を使用する）
                // 注: 本番では、CORSポリシー回避のためにプロキシサーバーが必要な場合があります
                
                // 実際の実装例:
                // const response = await fetch(SPREADSHEET_URL);
                // if (!response.ok) throw new Error('時刻表データの取得に失敗しました');
                // const csvData = await response.text();
                // state.busSchedule = parseCSV(csvData);
                
                // モックデータ（デモ用）
                const mockData = {
                    orange: {
                        weekday: ['7:00', '8:30', '10:00', '11:30', '13:00', '14:30', '16:00', '17:30'],
                        saturday: ['7:00', '8:30', '10:00', '11:30', '13:00', '14:30', '16:00', '17:30'],
                        holiday: ['9:00', '11:00', '13:00', '15:00', '17:00']
                    },
                    green: {
                        weekday: ['7:15', '8:45', '10:15', '11:45', '13:15', '14:45', '16:15', '17:45'],
                        saturday: ['7:15', '8:45', '10:15', '11:45', '13:15', '14:45', '16:15', '17:45'],
                        holiday: ['9:30', '11:30', '13:30', '15:30', '17:30']
                    }
                };
                
                state.busSchedule = mockData;
                return mockData;
            } catch (error) {
                console.error('バススケジュールの取得に失敗しました:', error);
                throw new Error('時刻表データの取得に失敗しました');
            }
        }
        
        // 祝日かどうかを確認
        async function checkIfHoliday() {
            try {
                // 実際の実装では、祝日APIを使用するか、祝日リストを使用
                // モックデータ（デモ用）- 今日が祝日かどうかをランダムに決定
                state.isHoliday = false; // 本番では実際の判定に置き換え
                
                // 例：特定の日付を祝日リストと比較する実装
                // const today = new Date();
                // const formattedDate = `${today.getFullYear()}-${(today.getMonth() + 1).toString().padStart(2, '0')}-${today.getDate().toString().padStart(2, '0')}`;
                // const holidayList = ['2025-01-01', '2025-01-13', ...]; // 実際の祝日リスト
                // state.isHoliday = holidayList.includes(formattedDate);
                
                return state.isHoliday;
            } catch (error) {
                console.error('祝日確認中にエラーが発生しました:', error);
                // エラーがあっても処理を続行（祝日でないと仮定）
                state.isHoliday = false;
                return false;
            }
        }
        
        // 気象条件を確認
        async function checkWeatherConditions() {
            try {
                // 実際の実装では、気象APIを使用
                // 例: OpenWeatherMap APIを使用する場合
                // const response = await fetch(`https://api.openweathermap.org/data/2.5/weather?id=${WEATHER_CITY_ID}&appid=${WEATHER_API_KEY}&units=metric&lang=ja`);
                // const data = await response.json();
                // const weatherId = data.weather[0].id;
                // 豪雨（大雨）、豪雪（大雪）、台風などの警報条件をチェック
                // state.isSuspendedDueToWeather = weatherId >= 200 && weatherId < 300 || weatherId >= 600 && weatherId < 700 && data.main.temp < 0;
                
                // モックデータ（デモ用）
                state.isSuspendedDueToWeather = false; // 本番では実際の判定に置き換え
                
                return state.isSuspendedDueToWeather;
            } catch (error) {
                console.error('気象条件確認中にエラーが発生しました:', error);
                // エラーがあっても処理を続行（運行中と仮定）
                state.isSuspendedDueToWeather = false;
                return false;
            }
        }
        
        // 次のバス発車時刻を計算
        function updateNextBusInfo() {
            if (!state.busSchedule) return;
            
            const now = new Date();
            const day = now.getDay(); // 0:日, 1:月, ... 6:土
            const currentHour = now.getHours();
            const currentMinute = now.getMinutes();
            const currentTimeValue = currentHour * 60 + currentMinute; // 分単位での現在時刻
            
            // 運行スケジュールの選択（平日、土曜、日曜・祝日）
            let schedule;
            if (state.isHoliday || day === 0) { // 祝日または日曜日
                schedule = state.busSchedule[state.currentRoute].holiday;
            } else if (day === 6) { // 土曜日
                schedule = state.busSchedule[state.currentRoute].saturday;
            } else { // 平日（月〜金）
                schedule = state.busSchedule[state.currentRoute].weekday;
            }
            
            // 運休かどうか判定
            if (state.isHoliday && !schedule) {
                updateStatus('not-running', '本日は祝日のため運休です');
                return;
            }
            
            if (state.isSuspendedDueToWeather) {
                updateStatus('not-running', '悪天候のため運休中です');
                return;
            }
            
            if (day === 0 && !schedule) { // 日曜日で運行がない場合
                updateStatus('not-running', '日曜日は運休です');
                return;
            }
            
            // 次のバスを探す
            let nextBusTime = null;
            let minutesToNext = Infinity;
            
            for (const timeStr of schedule) {
                const [hours, minutes] = timeStr.split(':').map(Number);
                const busTimeValue = hours * 60 + minutes; // 分単位でのバス時刻
                
                const diff = busTimeValue - currentTimeValue;
                
                if (diff > 0 && diff < minutesToNext) {
                    minutesToNext = diff;
                    nextBusTime = timeStr;
                }
            }
            
            // 次のバスがない場合（最終バスが過ぎた場合）
            if (!nextBusTime) {
                updateStatus('day-ended', '本日の運行は終了しました');
                return;
            }
            
            // 次のバス情報を更新
            state.nextBusDeparture = nextBusTime;
            state.minutesToNextBus = minutesToNext;
            
            updateStatus('running', '現在運行中です');
            nextBusEl.textContent = `次のバスは ${nextBusTime} （あと${minutesToNext}分）`;
        }
        
        // 運行状況表示を更新
        function updateStatus(statusClass, statusText) {
            state.operatingStatus = statusClass;
            statusEl.className = `status ${statusClass}`;
            statusEl.textContent = statusText;
            
            if (statusClass === 'not-running' || statusClass === 'day-ended') {
                nextBusEl.textContent = '次のバスはありません';
            }
        }
        
        // 時刻表を表示
        function updateTimetableDisplay() {
            if (!state.busSchedule) return;
            
            const now = new Date();
            const day = now.getDay();
            const currentHour = now.getHours();
            const currentMinute = now.getMinutes();
            const currentTimeValue = currentHour * 60 + currentMinute;
            
            // 運行スケジュールの選択
            let schedule;
            let scheduleType;
            
            if (state.isHoliday || day === 0) {
                schedule = state.busSchedule[state.currentRoute].holiday;
                scheduleType = '休日';
            } else if (day === 6) {
                schedule = state.busSchedule[state.currentRoute].saturday;
                scheduleType = '土曜';
            } else {
                schedule = state.busSchedule[state.currentRoute].weekday;
                scheduleType = '平日';
            }
            
            if (!schedule) {
                timetableEl.innerHTML = '<tr><td>本日の運行はありません</td></tr>';
                return;
            }
            
            // 時刻表のヘッダー
            let tableHTML = `
                <tr>
                    <th colspan="2">${state.currentRoute === 'orange' ? 'オレンジ' : 'グリーン'}コース（${scheduleType}）</th>
                </tr>
                <tr>
                    <th>出発時刻</th>
                    <th>状態</th>
                </tr>
            `;
            
            // 時刻表の内容
            for (const timeStr of schedule) {
                const [hours, minutes] = timeStr.split(':').map(Number);
                const busTimeValue = hours * 60 + minutes;
                
                let status = '';
                let rowClass = '';
                
                if (busTimeValue < currentTimeValue) {
                    status = '出発済み';
                } else if (timeStr === state.nextBusDeparture) {
                    status = `あと${state.minutesToNextBus}分`;
                    rowClass = 'next';
                } else {
                    const diff = busTimeValue - currentTimeValue;
                    status = `あと${diff}分`;
                }
                
                tableHTML += `
                    <tr class="${rowClass}">
                        <td>${timeStr}</td>
                        <td>${status}</td>
                    </tr>
                `;
            }
            
            timetableEl.innerHTML = tableHTML;
        }
        
        // ページ読み込み時にアプリを初期化
        window.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>